# 数据源层详细文档

## 概述

数据源层是系统的数据入口，负责从外部API获取金融数据，并提供统一的数据接口供上层模块使用。

**位置**: `src/tools/api.py`

---

## 数据源信息

### 主要数据提供商

**Financial Datasets API** (`https://api.financialdatasets.ai`)

- **主要用途**: 提供美股金融数据
- **数据覆盖**: 
  - 股票价格数据
  - 财务指标
  - 财务报表项目
  - 内幕交易记录
  - 公司新闻
  - 公司基本信息

### API认证

- **认证方式**: API Key通过HTTP Header传递
- **Header名称**: `X-API-KEY`
- **环境变量**: `FINANCIAL_DATASETS_API_KEY`
- **免费数据**: AAPL, GOOGL, MSFT, NVDA, TSLA 无需API Key

---

## 数据获取函数详解

### 1. `get_prices()` - 获取价格数据

**功能**: 获取指定时间范围内的股票价格数据

**参数**:
- `ticker` (str): 股票代码，如 "AAPL"
- `start_date` (str): 开始日期，格式 "YYYY-MM-DD"
- `end_date` (str): 结束日期，格式 "YYYY-MM-DD"
- `api_key` (str, optional): API密钥，默认从环境变量获取

**返回**: `list[Price]` - Price对象列表

**Price对象结构**:
```python
class Price(BaseModel):
    open: float      # 开盘价
    close: float     # 收盘价
    high: float      # 最高价
    low: float       # 最低价
    volume: int      # 成交量
    time: str        # 时间戳
```

**API端点**: 
```
GET https://api.financialdatasets.ai/prices/
?ticker={ticker}
&interval=day
&interval_multiplier=1
&start_date={start_date}
&end_date={end_date}
```

**数据流程**:
1. 检查缓存（通过缓存键：`{ticker}_{start_date}_{end_date}`）
2. 如果缓存未命中，调用API
3. 解析响应为Pydantic模型
4. 存储到缓存
5. 返回Price对象列表

**示例**:
```python
prices = get_prices("AAPL", "2024-01-01", "2024-01-31")
# 返回: [Price(open=150.0, close=152.0, ...), ...]
```

---

### 2. `get_financial_metrics()` - 获取财务指标

**功能**: 获取公司的财务指标数据（如PE比率、ROE、利润率等）

**参数**:
- `ticker` (str): 股票代码
- `end_date` (str): 截止日期
- `period` (str): 报告期类型，可选 "ttm"（过去12个月）或 "annual"（年度）
- `limit` (int): 返回的记录数限制，默认10
- `api_key` (str, optional): API密钥

**返回**: `list[FinancialMetrics]` - 财务指标对象列表

**FinancialMetrics对象包含的主要字段**:
```python
class FinancialMetrics(BaseModel):
    ticker: str
    report_period: str          # 报告期
    period: str                  # 期间类型
    currency: str                # 货币
    
    # 估值指标
    market_cap: float | None                    # 市值
    enterprise_value: float | None             # 企业价值
    price_to_earnings_ratio: float | None      # PE比率
    price_to_book_ratio: float | None          # PB比率
    price_to_sales_ratio: float | None         # PS比率
    peg_ratio: float | None                    # PEG比率
    
    # 盈利能力指标
    gross_margin: float | None                 # 毛利率
    operating_margin: float | None             # 营业利润率
    net_margin: float | None                   # 净利润率
    return_on_equity: float | None             # ROE
    return_on_assets: float | None             # ROA
    return_on_invested_capital: float | None   # ROIC
    
    # 财务健康指标
    current_ratio: float | None                # 流动比率
    quick_ratio: float | None                  # 速动比率
    debt_to_equity: float | None               # 负债权益比
    interest_coverage: float | None            # 利息覆盖率
    
    # 增长指标
    revenue_growth: float | None               # 收入增长率
    earnings_growth: float | None              # 盈利增长率
    free_cash_flow_growth: float | None        # 自由现金流增长率
    
    # 每股指标
    earnings_per_share: float | None           # 每股收益
    book_value_per_share: float | None         # 每股净资产
    free_cash_flow_per_share: float | None     # 每股自由现金流
```

**API端点**:
```
GET https://api.financialdatasets.ai/financial-metrics/
?ticker={ticker}
&report_period_lte={end_date}
&limit={limit}
&period={period}
```

**缓存键**: `{ticker}_{period}_{end_date}_{limit}`

**使用场景**: 
- 价值投资分析（PE, PB等）
- 盈利能力评估（ROE, ROA等）
- 财务健康度检查（流动比率、负债率等）

---

### 3. `search_line_items()` - 搜索财务报表项目

**功能**: 搜索财务报表中的特定项目（如收入、净利润、自由现金流等）

**参数**:
- `ticker` (str): 股票代码
- `line_items` (list[str]): 要搜索的财务报表项目名称列表
- `end_date` (str): 截止日期
- `period` (str): 报告期类型，默认 "ttm"
- `limit` (int): 返回记录数，默认10
- `api_key` (str, optional): API密钥

**返回**: `list[LineItem]` - 财务报表项目对象列表

**常用line_items**:
```python
[
    "revenue",                          # 收入
    "net_income",                       # 净利润
    "free_cash_flow",                   # 自由现金流
    "operating_income",                 # 营业利润
    "total_assets",                     # 总资产
    "total_liabilities",                # 总负债
    "shareholders_equity",              # 股东权益
    "outstanding_shares",               # 流通股数
    "cash_and_equivalents",             # 现金及等价物
    "total_debt",                       # 总债务
    "capital_expenditure",              # 资本支出
    "research_and_development",        # 研发费用
    "dividends_and_other_cash_distributions",  # 股息
]
```

**API端点**:
```
POST https://api.financialdatasets.ai/financials/search/line-items
Body: {
    "tickers": [ticker],
    "line_items": [...],
    "end_date": end_date,
    "period": period,
    "limit": limit
}
```

**使用场景**:
- 计算自定义财务比率
- 分析现金流状况
- 评估资本结构
- 计算每股指标

---

### 4. `get_insider_trades()` - 获取内幕交易数据

**功能**: 获取公司内部人员的交易记录（高管、董事等）

**参数**:
- `ticker` (str): 股票代码
- `end_date` (str): 截止日期
- `start_date` (str, optional): 开始日期，用于时间范围过滤
- `limit` (int): 每页返回记录数，默认1000
- `api_key` (str, optional): API密钥

**返回**: `list[InsiderTrade]` - 内幕交易对象列表

**InsiderTrade对象结构**:
```python
class InsiderTrade(BaseModel):
    ticker: str
    issuer: str | None                    # 发行人
    name: str | None                      # 交易人姓名
    title: str | None                     # 职位
    is_board_director: bool | None        # 是否为董事
    transaction_date: str | None          # 交易日期
    transaction_shares: float | None      # 交易股数
    transaction_price_per_share: float | None  # 交易价格
    transaction_value: float | None       # 交易金额
    shares_owned_before_transaction: float | None  # 交易前持股
    shares_owned_after_transaction: float | None   # 交易后持股
    security_title: str | None            # 证券类型
    filing_date: str                      # 申报日期
```

**API端点**:
```
GET https://api.financialdatasets.ai/insider-trades/
?ticker={ticker}
&filing_date_lte={end_date}
&filing_date_gte={start_date}  # 可选
&limit={limit}
```

**分页处理**: 
- 如果设置了`start_date`且返回了完整一页数据，会自动分页获取所有数据
- 通过更新`end_date`为当前批次最早日期来继续获取历史数据

**缓存键**: `{ticker}_{start_date or 'none'}_{end_date}_{limit}`

**使用场景**:
- 分析内部人员买卖行为
- 评估管理层信心
- 识别潜在的内幕信息

---

### 5. `get_company_news()` - 获取公司新闻

**功能**: 获取与公司相关的新闻文章

**参数**:
- `ticker` (str): 股票代码
- `end_date` (str): 截止日期
- `start_date` (str, optional): 开始日期
- `limit` (int): 每页返回记录数，默认1000
- `api_key` (str, optional): API密钥

**返回**: `list[CompanyNews]` - 新闻对象列表

**CompanyNews对象结构**:
```python
class CompanyNews(BaseModel):
    ticker: str
    title: str                    # 新闻标题
    author: str                   # 作者
    source: str                   # 来源
    date: str                     # 发布日期
    url: str                      # 新闻链接
    sentiment: str | None         # 情感分析结果（如果有）
```

**API端点**:
```
GET https://api.financialdatasets.ai/news/
?ticker={ticker}
&end_date={end_date}
&start_date={start_date}  # 可选
&limit={limit}
```

**分页处理**: 与内幕交易类似，支持自动分页获取历史数据

**缓存键**: `{ticker}_{start_date or 'none'}_{end_date}_{limit}`

**使用场景**:
- 新闻情感分析
- 事件驱动分析
- 市场情绪评估

---

### 6. `get_market_cap()` - 获取市值

**功能**: 获取公司在指定日期的市值

**参数**:
- `ticker` (str): 股票代码
- `end_date` (str): 日期
- `api_key` (str, optional): API密钥

**返回**: `float | None` - 市值（美元），如果获取失败返回None

**实现逻辑**:
1. 如果`end_date`是今天，从Company Facts API获取最新市值
2. 否则，从财务指标数据中获取历史市值

**API端点**:
- 当前日期: `GET https://api.financialdatasets.ai/company/facts/?ticker={ticker}`
- 历史日期: 通过`get_financial_metrics()`获取

---

### 7. `get_price_data()` - 获取价格DataFrame

**功能**: 获取价格数据并转换为Pandas DataFrame格式

**参数**:
- `ticker` (str): 股票代码
- `start_date` (str): 开始日期
- `end_date` (str): 结束日期
- `api_key` (str, optional): API密钥

**返回**: `pd.DataFrame` - 包含价格数据的DataFrame

**DataFrame结构**:
- **索引**: Date (datetime)
- **列**: open, close, high, low, volume (均为数值类型)
- **排序**: 按日期升序排列

**使用场景**:
- 技术分析
- 计算技术指标
- 回测引擎中的价格查询

---

## API请求处理机制

### 速率限制处理

**函数**: `_make_api_request()`

**功能**: 统一的API请求处理，包含重试和速率限制处理

**重试策略**:
- **最大重试次数**: 3次（默认）
- **速率限制响应**: HTTP 429
- **退避策略**: 线性退避
  - 第1次重试: 等待60秒
  - 第2次重试: 等待90秒
  - 第3次重试: 等待120秒
  - 公式: `delay = 60 + (30 * attempt)`

**错误处理**:
- 非429错误: 立即抛出异常
- 429错误: 等待后重试，最多重试3次
- 最终失败: 抛出异常

**示例**:
```python
def _make_api_request(url, headers, method="GET", json_data=None, max_retries=3):
    for attempt in range(max_retries + 1):
        response = requests.get(url, headers=headers)
        
        if response.status_code == 429 and attempt < max_retries:
            delay = 60 + (30 * attempt)
            time.sleep(delay)
            continue
        
        return response
```

---

## 数据缓存集成

所有数据获取函数都集成了缓存机制：

1. **缓存检查**: 在API调用前先检查缓存
2. **缓存键生成**: 基于函数参数生成唯一缓存键
3. **缓存存储**: API响应解析后存储到缓存
4. **缓存位置**: `src/data/cache.py` (详见数据缓存层文档)

**缓存优势**:
- 减少API调用次数
- 提高回测速度
- 降低API成本
- 支持离线开发

---

## 数据模型验证

所有API响应都通过**Pydantic模型**进行验证：

1. **类型检查**: 自动验证数据类型
2. **数据转换**: 自动转换数据类型
3. **缺失值处理**: 支持可选字段（`| None`）
4. **数据验证**: 确保数据符合预期格式

**优势**:
- 类型安全
- 早期错误检测
- 清晰的API契约
- IDE自动补全支持

---

## 使用示例

### 完整的数据获取流程

```python
from src.tools.api import (
    get_prices,
    get_financial_metrics,
    get_insider_trades,
    get_company_news,
    get_market_cap,
    search_line_items,
)

# 1. 获取价格数据
prices = get_prices("AAPL", "2024-01-01", "2024-01-31")

# 2. 获取财务指标
metrics = get_financial_metrics("AAPL", "2024-01-31", period="ttm", limit=10)

# 3. 获取财务报表项目
line_items = search_line_items(
    "AAPL",
    ["revenue", "net_income", "free_cash_flow"],
    "2024-01-31",
    period="annual",
    limit=5
)

# 4. 获取内幕交易
insider_trades = get_insider_trades(
    "AAPL",
    "2024-01-31",
    start_date="2023-01-01",
    limit=1000
)

# 5. 获取公司新闻
news = get_company_news(
    "AAPL",
    "2024-01-31",
    start_date="2024-01-01",
    limit=100
)

# 6. 获取市值
market_cap = get_market_cap("AAPL", "2024-01-31")
```

---

## 扩展性

### 添加新的数据源

要添加新的数据源，需要：

1. **创建新的获取函数**:
```python
def get_new_data(ticker: str, ...) -> NewDataModel:
    cache_key = f"{ticker}_{...}"
    
    # 检查缓存
    if cached := _cache.get_new_data(cache_key):
        return [NewDataModel(**d) for d in cached]
    
    # 调用API
    url = "https://new-api.com/data"
    response = _make_api_request(url, headers)
    
    # 解析和缓存
    data = parse_response(response)
    _cache.set_new_data(cache_key, [d.model_dump() for d in data])
    
    return data
```

2. **添加数据模型** (在`src/data/models.py`):
```python
class NewDataModel(BaseModel):
    field1: str
    field2: float
    ...
```

3. **更新缓存类** (在`src/data/cache.py`):
```python
def get_new_data(self, key: str) -> list[dict] | None:
    return self._new_data_cache.get(key)

def set_new_data(self, key: str, data: list[dict]):
    self._new_data_cache[key] = data
```

---

## 注意事项

1. **API限制**: 注意API的速率限制和调用配额
2. **数据质量**: 某些数据可能缺失，需要处理None值
3. **时区问题**: 日期时间使用UTC或市场时区
4. **数据延迟**: 财务数据可能有报告延迟
5. **缓存一致性**: 缓存数据可能不是最新的，需要定期清理

---

## 总结

数据源层提供了统一、可靠的数据获取接口，通过缓存机制优化性能，通过Pydantic模型确保数据质量。所有函数都遵循相同的模式：缓存检查 → API调用 → 数据验证 → 缓存存储 → 返回结果。

