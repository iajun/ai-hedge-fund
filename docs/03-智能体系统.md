# 智能体系统详细文档

## 概述

智能体系统是AI Hedge Fund的核心，由18个专业投资策略智能体组成，每个智能体代表不同的投资理念和策略。所有智能体通过LangGraph工作流协调工作，共同生成投资决策。

**位置**: `src/agents/`

---

## 智能体架构

### 智能体分类

#### 1. 价值投资流派（5个）

| 智能体 | 投资理念 | 核心关注点 |
|--------|---------|-----------|
| **Warren Buffett** | 寻找优质公司，长期持有 | 护城河、管理层、盈利能力 |
| **Ben Graham** | 安全边际，深度价值 | 低PB、低PE、净流动资产 |
| **Charlie Munger** | 优质企业，合理价格 | 业务质量、理性决策 |
| **Michael Burry** | 反向投资，深度价值 | 被低估资产、基本面分析 |
| **Mohnish Pabrai** | Dhandho投资，低风险高回报 | 价值投资、安全边际 |

#### 2. 成长投资流派（3个）

| 智能体 | 投资理念 | 核心关注点 |
|--------|---------|-----------|
| **Cathie Wood** | 颠覆性创新，高增长 | 技术创新、市场颠覆、TAM |
| **Peter Lynch** | 买你了解的公司 | 业务可理解性、增长潜力 |
| **Phil Fisher** | 深度研究，长期增长 | 管理层质量、产品创新 |

#### 3. 宏观与策略流派（3个）

| 智能体 | 投资理念 | 核心关注点 |
|--------|---------|-----------|
| **Stanley Druckenmiller** | 宏观趋势，不对称机会 | 宏观经济、货币、商品 |
| **Bill Ackman** | 激进投资，推动变革 | 业务质量、激进潜力 |
| **Rakesh Jhunjhunwala** | 新兴市场，高增长 | 宏观经济、新兴市场机会 |

#### 4. 量化分析流派（7个）

| 智能体 | 分析类型 | 核心关注点 |
|--------|---------|-----------|
| **Aswath Damodaran** | 估值分析 | 内在价值、DCF模型 |
| **Valuation Agent** | 估值分析 | 多种估值模型 |
| **Fundamentals Agent** | 基本面分析 | 财务指标、财务健康 |
| **Technicals Agent** | 技术分析 | 图表模式、技术指标 |
| **Sentiment Agent** | 市场情绪 | 投资者情绪、市场心理 |
| **News Sentiment Agent** | 新闻情绪 | 新闻情感分析 |
| **Growth Agent** | 增长分析 | 增长趋势、增长质量 |

#### 5. 风险管理（2个）

| 智能体 | 功能 | 核心关注点 |
|--------|------|-----------|
| **Risk Manager** | 风险控制 | 波动率、相关性、仓位限制 |
| **Portfolio Manager** | 组合管理 | 信号整合、最终决策 |

---

## 智能体工作流程

### 标准智能体执行流程

每个分析智能体遵循相同的执行模式：

```
1. 初始化
   ├─ 从state中提取数据（tickers, dates, portfolio）
   ├─ 获取API密钥
   └─ 初始化分析结果字典

2. 对每个ticker循环
   ├─ 数据获取阶段
   │  ├─ 获取财务指标 (get_financial_metrics)
   │  ├─ 获取财务报表项目 (search_line_items)
   │  ├─ 获取价格数据 (get_prices)
   │  ├─ 获取内幕交易 (get_insider_trades) - 可选
   │  ├─ 获取公司新闻 (get_company_news) - 可选
   │  └─ 获取市值 (get_market_cap)
   │
   ├─ 数据分析阶段
   │  ├─ 计算财务比率
   │  ├─ 分析趋势
   │  ├─ 评估业务质量
   │  └─ 生成分析摘要
   │
   ├─ LLM推理阶段
   │  ├─ 构建提示词（包含投资理念、数据、分析）
   │  ├─ 调用LLM生成投资信号
   │  └─ 解析LLM响应
   │
   └─ 信号生成阶段
      ├─ 生成信号（buy/sell/hold/short）
      ├─ 计算置信度（0-100）
      └─ 生成推理说明

3. 返回结果
   ├─ 更新state中的analyst_signals
   └─ 返回更新后的state
```

---

## 智能体实现详解

### 示例：Warren Buffett Agent

**文件**: `src/agents/warren_buffett.py`

#### 1. 信号模型定义

```python
class WarrenBuffettSignal(BaseModel):
    signal: Literal["buy", "sell", "hold", "short"]
    confidence: int  # 0-100
    reasoning: str
```

#### 2. 数据获取

```python
def warren_buffett_agent(state: AgentState):
    # 获取基础数据
    metrics = get_financial_metrics(ticker, end_date, period="ttm", limit=10)
    
    # 获取财务报表项目
    line_items = search_line_items(
        ticker,
        [
            "revenue", "net_income", "free_cash_flow",
            "shareholders_equity", "total_assets", ...
        ],
        end_date,
        period="ttm",
        limit=10
    )
    
    # 获取市值
    market_cap = get_market_cap(ticker, end_date)
    
    # 获取内幕交易（评估管理层）
    insider_trades = get_insider_trades(ticker, end_date, limit=100)
```

#### 3. 数据分析

```python
# 分析基本面
fundamental_analysis = analyze_fundamentals(metrics)
# 返回: ROE, ROA, 利润率, 债务水平等

# 分析一致性
consistency_analysis = analyze_consistency(line_items)
# 返回: 收入增长稳定性, 盈利稳定性等

# 分析竞争护城河
moat_analysis = analyze_competitive_moat(metrics, line_items)
# 返回: 品牌价值, 市场份额, 定价能力等
```

#### 4. LLM推理

```python
# 构建提示词
prompt = f"""
你是一位遵循Warren Buffett投资原则的分析师。

投资原则：
1. 寻找具有强大护城河的公司
2. 优秀的管理层
3. 可预测的盈利增长
4. 合理的估值

股票数据：
- 股票代码: {ticker}
- 市值: ${market_cap:,.0f}
- 基本面分析: {fundamental_analysis}
- 一致性分析: {consistency_analysis}
- 护城河分析: {moat_analysis}

请基于以上数据，生成投资建议。
"""

# 调用LLM
signal = call_llm(
    prompt=prompt,
    pydantic_model=WarrenBuffettSignal,
    agent_name="warren_buffett_agent",
    state=state
)
```

#### 5. 返回结果

```python
# 存储信号
buffett_analysis[ticker] = {
    "signal": signal.signal,
    "confidence": signal.confidence,
    "reasoning": signal.reasoning
}

# 更新state
state["data"]["analyst_signals"]["warren_buffett_agent"] = buffett_analysis

return {
    "messages": state["messages"] + [message],
    "data": state["data"]
}
```

---

## 智能体配置系统

### 配置定义

**位置**: `src/utils/analysts.py`

**配置结构**:
```python
ANALYST_CONFIG = {
    "warren_buffett": {
        "display_name": "Warren Buffett",
        "description": "The Oracle of Omaha",
        "investing_style": "Seeks companies with strong fundamentals...",
        "agent_func": warren_buffett_agent,
        "type": "analyst",
        "order": 10,
    },
    # ... 其他智能体
}
```

### 配置字段说明

- **display_name**: 显示名称（用于UI）
- **description**: 简短描述
- **investing_style**: 投资风格详细说明
- **agent_func**: 智能体函数引用
- **type**: 类型（"analyst" 或 "manager"）
- **order**: 执行顺序（用于UI排序）

### 获取智能体节点

```python
def get_analyst_nodes():
    """返回智能体键到(node_name, agent_func)的映射"""
    return {
        key: (f"{key}_agent", config["agent_func"])
        for key, config in ANALYST_CONFIG.items()
    }
```

---

## 风险管理智能体详解

### Risk Manager Agent

**文件**: `src/agents/risk_manager.py`

#### 核心功能

1. **波动率计算**
   - 计算日波动率和年化波动率
   - 使用60天滚动窗口
   - 计算波动率百分位数

2. **相关性分析**
   - 计算股票之间的相关性矩阵
   - 识别高相关性股票
   - 调整仓位限制

3. **仓位限制计算**
   - 基于波动率调整基础仓位限制
   - 基于相关性进一步调整
   - 考虑当前持仓和可用现金

#### 波动率调整逻辑

```python
def calculate_volatility_adjusted_limit(annualized_volatility: float) -> float:
    """
    根据波动率调整仓位限制百分比
    
    逻辑：
    - 低波动率 (<15%): 最高25%配置
    - 中等波动率 (15-30%): 15-20%配置
    - 高波动率 (30-50%): 10-15%配置
    - 极高波动率 (>50%): 最高10%配置
    """
    base_limit = 0.20  # 20%基础限制
    
    if annualized_volatility < 0.15:
        vol_multiplier = 1.25  # 最高25%
    elif annualized_volatility < 0.30:
        vol_multiplier = 1.0 - (annualized_volatility - 0.15) * 0.5
    elif annualized_volatility < 0.50:
        vol_multiplier = 0.75 - (annualized_volatility - 0.30) * 0.5
    else:
        vol_multiplier = 0.50  # 最高10%
    
    return base_limit * max(0.25, min(1.25, vol_multiplier))
```

#### 相关性调整逻辑

```python
def calculate_correlation_multiplier(avg_correlation: float) -> float:
    """
    根据平均相关性调整仓位限制
    
    - 极高相关性 (>=0.8): 降低到0.7x
    - 高相关性 (0.6-0.8): 降低到0.85x
    - 中等相关性 (0.4-0.6): 保持1.0x
    - 低相关性 (0.2-0.4): 增加到1.05x
    - 极低相关性 (<0.2): 增加到1.10x
    """
    if avg_correlation >= 0.80:
        return 0.70
    if avg_correlation >= 0.60:
        return 0.85
    if avg_correlation >= 0.40:
        return 1.00
    if avg_correlation >= 0.20:
        return 1.05
    return 1.10
```

#### 输出结构

```python
risk_analysis[ticker] = {
    "remaining_position_limit": float,  # 剩余仓位限制（美元）
    "current_price": float,              # 当前价格
    "volatility_metrics": {
        "daily_volatility": float,
        "annualized_volatility": float,
        "volatility_percentile": float,
        "data_points": int
    },
    "correlation_metrics": {
        "avg_correlation_with_active": float | None,
        "max_correlation_with_active": float | None,
        "top_correlated_tickers": list[dict]
    },
    "reasoning": {
        "portfolio_value": float,
        "current_position_value": float,
        "base_position_limit_pct": float,
        "correlation_multiplier": float,
        "combined_position_limit_pct": float,
        "position_limit": float,
        "remaining_limit": float,
        "available_cash": float,
        "risk_adjustment": str
    }
}
```

---

## 投资组合管理智能体详解

### Portfolio Manager Agent

**文件**: `src/agents/portfolio_manager.py`

#### 核心功能

1. **信号整合**
   - 收集所有分析智能体的信号
   - 提取信号类型和置信度
   - 按ticker组织信号

2. **约束计算**
   - 计算允许的交易操作
   - 计算最大交易数量
   - 考虑现金、保证金、当前持仓

3. **最终决策**
   - 使用LLM整合所有信号
   - 在约束范围内生成交易决策
   - 生成决策理由

#### 允许操作计算

```python
def compute_allowed_actions(tickers, current_prices, max_shares, portfolio):
    """
    计算每个ticker允许的交易操作和最大数量
    
    逻辑：
    - 买入: 如果有现金且价格>0，计算可买数量
    - 卖出: 如果有持仓，可卖出数量=当前持仓
    - 做空: 如果有保证金，计算可做空数量
    - 平仓: 如果有空头持仓，可平仓数量=当前空头持仓
    - 持有: 总是允许
    """
    allowed = {}
    cash = portfolio.get("cash", 0.0)
    positions = portfolio.get("positions", {})
    
    for ticker in tickers:
        price = current_prices.get(ticker, 0.0)
        pos = positions.get(ticker, {})
        long_shares = pos.get("long", 0)
        short_shares = pos.get("short", 0)
        max_qty = max_shares.get(ticker, 0)
        
        actions = {"hold": 0}
        
        # 买入逻辑
        if cash > 0 and price > 0:
            max_buy_cash = int(cash // price)
            max_buy = max(0, min(max_qty, max_buy_cash))
            if max_buy > 0:
                actions["buy"] = max_buy
        
        # 卖出逻辑
        if long_shares > 0:
            actions["sell"] = long_shares
        
        # 做空逻辑
        if price > 0 and max_qty > 0:
            available_margin = calculate_available_margin(portfolio)
            max_short_margin = int(available_margin // price)
            max_short = max(0, min(max_qty, max_short_margin))
            if max_short > 0:
                actions["short"] = max_short
        
        # 平仓逻辑
        if short_shares > 0:
            actions["cover"] = short_shares
        
        allowed[ticker] = actions
    
    return allowed
```

#### LLM决策生成

```python
def generate_trading_decision(
    tickers, signals_by_ticker, current_prices, max_shares, portfolio, state
):
    """
    使用LLM生成最终交易决策
    
    输入：
    - signals_by_ticker: {ticker: {agent: {sig, conf}}}
    - allowed_actions: {ticker: {action: max_qty}}
    
    输出：
    - decisions: {ticker: {action, quantity, confidence, reasoning}}
    """
    # 构建紧凑的信号表示
    compact_signals = _compact_signals(signals_by_ticker)
    
    # 构建提示词
    prompt = f"""
    你是投资组合经理。
    
    输入（每个ticker）：
    - 分析师信号和置信度
    - 允许的操作和最大数量（已验证）
    
    任务：
    为每个ticker选择一个允许的操作和数量（≤最大值）。
    保持推理简洁（最多100字符）。
    只返回JSON。
    """
    
    # 调用LLM
    result = call_llm(
        prompt=prompt,
        pydantic_model=PortfolioManagerOutput,
        agent_name="portfolio_manager",
        state=state
    )
    
    return result
```

---

## LLM集成

### LLM调用封装

**位置**: `src/utils/llm.py`

**核心函数**: `call_llm()`

**功能**:
- 统一的LLM调用接口
- 支持结构化输出（Pydantic模型）
- 自动重试机制
- 错误处理和默认值

**使用示例**:
```python
signal = call_llm(
    prompt=prompt,
    pydantic_model=WarrenBuffettSignal,
    agent_name="warren_buffett_agent",
    state=state,
    max_retries=3,
    default_factory=lambda: WarrenBuffettSignal(
        signal="hold",
        confidence=0,
        reasoning="Error in analysis"
    )
)
```

### 支持的LLM提供商

- OpenAI (GPT-4, GPT-4o, GPT-4o-mini等)
- Anthropic (Claude)
- Groq (DeepSeek, Llama等)
- Ollama (本地模型)
- Google (Gemini)
- 其他LangChain支持的提供商

---

## 智能体状态管理

### AgentState结构

```python
class AgentState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], operator.add]
    data: Annotated[dict[str, any], merge_dicts]
    metadata: Annotated[dict[str, any], merge_dicts]
```

**字段说明**:
- **messages**: LLM消息历史（自动累加）
- **data**: 业务数据（自动合并）
  - `tickers`: 股票列表
  - `portfolio`: 投资组合状态
  - `start_date`, `end_date`: 日期范围
  - `analyst_signals`: 所有智能体的信号
- **metadata**: 元数据（自动合并）
  - `show_reasoning`: 是否显示推理过程
  - `model_name`, `model_provider`: LLM配置

---

## 进度跟踪

### 进度更新机制

**位置**: `src/utils/progress.py`

**使用方式**:
```python
progress.update_status(agent_id, ticker, "Fetching financial metrics")
progress.update_status(agent_id, ticker, "Analyzing fundamentals")
progress.update_status(agent_id, None, "Done")
```

**功能**:
- 实时更新智能体执行状态
- 支持CLI和Web界面显示
- 帮助用户了解系统运行情况

---

## 扩展智能体

### 添加新智能体步骤

1. **创建智能体文件** (`src/agents/new_agent.py`):
```python
from pydantic import BaseModel
from typing_extensions import Literal

class NewAgentSignal(BaseModel):
    signal: Literal["buy", "sell", "hold", "short"]
    confidence: int
    reasoning: str

def new_agent(state: AgentState, agent_id: str = "new_agent"):
    # 1. 获取数据
    # 2. 分析数据
    # 3. 调用LLM
    # 4. 返回信号
    pass
```

2. **注册智能体** (`src/utils/analysts.py`):
```python
ANALYST_CONFIG["new_agent"] = {
    "display_name": "New Agent",
    "description": "Description",
    "investing_style": "Style description",
    "agent_func": new_agent,
    "type": "analyst",
    "order": 20,
}
```

3. **导入智能体** (`src/utils/analysts.py`):
```python
from src.agents.new_agent import new_agent
```

---

## 总结

智能体系统通过18个专业投资策略智能体的协作，实现了多角度、全方位的投资分析。每个智能体都遵循统一的工作流程，通过数据获取、分析、LLM推理生成投资信号。风险管理智能体和投资组合管理智能体负责整合所有信号，生成最终的交易决策。

**核心特点**:
- ✅ 18个专业投资策略智能体
- ✅ 统一的工作流程和接口
- ✅ LLM驱动的智能推理
- ✅ 完整的风险控制机制
- ✅ 易于扩展和定制

