# å·¥ä½œæµå¼•æ“è¯¦ç»†æ–‡æ¡£

## æ¦‚è¿°

å·¥ä½œæµå¼•æ“ä½¿ç”¨LangGraphæ„å»ºï¼Œè´Ÿè´£åè°ƒå¤šä¸ªæ™ºèƒ½ä½“çš„æ‰§è¡Œé¡ºåºï¼Œç®¡ç†çŠ¶æ€æµè½¬ï¼Œå®ç°å¤šæ™ºèƒ½ä½“åä½œå†³ç­–ã€‚

**ä½ç½®**: `src/main.py`, `src/graph/state.py`

**æŠ€æœ¯æ ˆ**: LangGraph (LangChainçš„å·¥ä½œæµç¼–æ’æ¡†æ¶)

---

## LangGraphåŸºç¡€

### ä»€ä¹ˆæ˜¯LangGraph

LangGraphæ˜¯LangChainæä¾›çš„å·¥ä½œæµç¼–æ’æ¡†æ¶ï¼Œç”¨äºæ„å»ºæœ‰çŠ¶æ€çš„AIåº”ç”¨ã€‚å®ƒåŸºäºçŠ¶æ€æœºæ¨¡å‹ï¼Œæ”¯æŒï¼š

- **èŠ‚ç‚¹ï¼ˆNodesï¼‰**: æ‰§è¡Œå…·ä½“ä»»åŠ¡çš„å‡½æ•°
- **è¾¹ï¼ˆEdgesï¼‰**: å®šä¹‰èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»
- **çŠ¶æ€ï¼ˆStateï¼‰**: åœ¨èŠ‚ç‚¹é—´å…±äº«çš„æ•°æ®
- **æ¡ä»¶è¾¹ï¼ˆConditional Edgesï¼‰**: åŸºäºçŠ¶æ€çš„æ¡ä»¶è·¯ç”±

### æ ¸å¿ƒæ¦‚å¿µ

1. **StateGraph**: çŠ¶æ€å›¾ï¼Œå®šä¹‰å·¥ä½œæµçš„æ•´ä½“ç»“æ„
2. **AgentState**: çŠ¶æ€ç±»å‹ï¼Œå®šä¹‰å…±äº«æ•°æ®çš„ç»“æ„
3. **èŠ‚ç‚¹å‡½æ•°**: æ¥æ”¶çŠ¶æ€ï¼Œè¿”å›æ›´æ–°åçš„çŠ¶æ€
4. **è¾¹**: å®šä¹‰èŠ‚ç‚¹æ‰§è¡Œé¡ºåº

---

## å·¥ä½œæµæ¶æ„

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  start_node â”‚ (å…¥å£èŠ‚ç‚¹)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                 â”‚
       â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analyst 1   â”‚                  â”‚ Analyst 2   â”‚
â”‚ (å¹¶è¡Œæ‰§è¡Œ)   â”‚                  â”‚ (å¹¶è¡Œæ‰§è¡Œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ (æ‰€æœ‰åˆ†ææ™ºèƒ½ä½“å®Œæˆå)
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ risk_management_agentâ”‚ (é£é™©ç®¡ç†)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ portfolio_manager     â”‚ (ç»„åˆç®¡ç†)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                  END
```

### çŠ¶æ€æµè½¬

```
åˆå§‹çŠ¶æ€
  â†“
[æ‰€æœ‰åˆ†ææ™ºèƒ½ä½“å¹¶è¡Œæ‰§è¡Œ]
  â†“
çŠ¶æ€æ›´æ–°ï¼ˆanalyst_signalsï¼‰
  â†“
[é£é™©ç®¡ç†æ™ºèƒ½ä½“æ‰§è¡Œ]
  â†“
çŠ¶æ€æ›´æ–°ï¼ˆé£é™©é™åˆ¶ï¼‰
  â†“
[æŠ•èµ„ç»„åˆç®¡ç†æ™ºèƒ½ä½“æ‰§è¡Œ]
  â†“
æœ€ç»ˆçŠ¶æ€ï¼ˆäº¤æ˜“å†³ç­–ï¼‰
```

---

## AgentStateè¯¦è§£

### çŠ¶æ€å®šä¹‰

**ä½ç½®**: `src/graph/state.py`

```python
class AgentState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], operator.add]
    data: Annotated[dict[str, any], merge_dicts]
    metadata: Annotated[dict[str, any], merge_dicts]
```

### å­—æ®µè¯´æ˜

#### 1. messages

**ç±»å‹**: `Annotated[Sequence[BaseMessage], operator.add]`

**ä½œç”¨**: å­˜å‚¨LLMæ¶ˆæ¯å†å²

**åˆå¹¶ç­–ç•¥**: `operator.add` - è‡ªåŠ¨ç´¯åŠ 

**å†…å®¹**: 
- æ¯ä¸ªæ™ºèƒ½ä½“çš„HumanMessageè¾“å‡º
- åŒ…å«æ™ºèƒ½ä½“çš„åˆ†æç»“æœå’Œå†³ç­–

**ç¤ºä¾‹**:
```python
messages = [
    HumanMessage(content='{"AAPL": {"signal": "buy", ...}}', name="warren_buffett_agent"),
    HumanMessage(content='{"AAPL": {"signal": "hold", ...}}', name="cathie_wood_agent"),
    # ...
]
```

#### 2. data

**ç±»å‹**: `Annotated[dict[str, any], merge_dicts]`

**ä½œç”¨**: å­˜å‚¨ä¸šåŠ¡æ•°æ®

**åˆå¹¶ç­–ç•¥**: `merge_dicts` - å­—å…¸åˆå¹¶

**ç»“æ„**:
```python
data = {
    "tickers": ["AAPL", "MSFT", "NVDA"],
    "portfolio": {
        "cash": 100000.0,
        "positions": {...},
        "realized_gains": {...}
    },
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "analyst_signals": {
        "warren_buffett_agent": {
            "AAPL": {"signal": "buy", "confidence": 85, ...}
        },
        "risk_management_agent": {
            "AAPL": {"remaining_position_limit": 20000.0, ...}
        }
    },
    "current_prices": {
        "AAPL": 150.0,
        "MSFT": 300.0
    }
}
```

#### 3. metadata

**ç±»å‹**: `Annotated[dict[str, any], merge_dicts]`

**ä½œç”¨**: å­˜å‚¨å…ƒæ•°æ®å’Œé…ç½®

**åˆå¹¶ç­–ç•¥**: `merge_dicts` - å­—å…¸åˆå¹¶

**ç»“æ„**:
```python
metadata = {
    "show_reasoning": False,
    "model_name": "gpt-4.1",
    "model_provider": "OpenAI",
    "request": <Requestå¯¹è±¡>  # Webè¯·æ±‚å¯¹è±¡ï¼ˆå¦‚æœæœ‰ï¼‰
}
```

---

## å·¥ä½œæµæ„å»º

### åˆ›å»ºå·¥ä½œæµ

**ä½ç½®**: `src/main.py` - `create_workflow()`

```python
def create_workflow(selected_analysts=None):
    """åˆ›å»ºLangGraphå·¥ä½œæµ"""
    
    # 1. åˆ›å»ºçŠ¶æ€å›¾
    workflow = StateGraph(AgentState)
    
    # 2. æ·»åŠ å…¥å£èŠ‚ç‚¹
    workflow.add_node("start_node", start)
    
    # 3. è·å–æ™ºèƒ½ä½“èŠ‚ç‚¹é…ç½®
    analyst_nodes = get_analyst_nodes()
    
    # 4. ç¡®å®šè¦ä½¿ç”¨çš„æ™ºèƒ½ä½“
    if selected_analysts is None:
        selected_analysts = list(analyst_nodes.keys())  # ä½¿ç”¨æ‰€æœ‰æ™ºèƒ½ä½“
    
    # 5. æ·»åŠ åˆ†ææ™ºèƒ½ä½“èŠ‚ç‚¹ï¼ˆå¹¶è¡Œï¼‰
    for analyst_key in selected_analysts:
        node_name, node_func = analyst_nodes[analyst_key]
        workflow.add_node(node_name, node_func)
        workflow.add_edge("start_node", node_name)  # ä»å…¥å£è¿æ¥åˆ°æ¯ä¸ªåˆ†ææ™ºèƒ½ä½“
    
    # 6. æ·»åŠ é£é™©ç®¡ç†èŠ‚ç‚¹
    workflow.add_node("risk_management_agent", risk_management_agent)
    
    # 7. è¿æ¥åˆ†ææ™ºèƒ½ä½“åˆ°é£é™©ç®¡ç†
    for analyst_key in selected_analysts:
        node_name = analyst_nodes[analyst_key][0]
        workflow.add_edge(node_name, "risk_management_agent")
    
    # 8. æ·»åŠ æŠ•èµ„ç»„åˆç®¡ç†èŠ‚ç‚¹
    workflow.add_node("portfolio_manager", portfolio_management_agent)
    
    # 9. è¿æ¥é£é™©ç®¡ç†åˆ°ç»„åˆç®¡ç†
    workflow.add_edge("risk_management_agent", "portfolio_manager")
    
    # 10. è®¾ç½®ç»“æŸèŠ‚ç‚¹
    workflow.add_edge("portfolio_manager", END)
    
    # 11. è®¾ç½®å…¥å£ç‚¹
    workflow.set_entry_point("start_node")
    
    return workflow
```

### èŠ‚ç‚¹å‡½æ•°

#### 1. startèŠ‚ç‚¹

```python
def start(state: AgentState):
    """åˆå§‹åŒ–å·¥ä½œæµï¼Œä¸åšä»»ä½•ä¿®æ”¹"""
    return state
```

#### 2. åˆ†ææ™ºèƒ½ä½“èŠ‚ç‚¹

æ¯ä¸ªåˆ†ææ™ºèƒ½ä½“éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š

```python
def warren_buffett_agent(state: AgentState, agent_id: str = "warren_buffett_agent"):
    # 1. ä»stateä¸­æå–æ•°æ®
    tickers = state["data"]["tickers"]
    end_date = state["data"]["end_date"]
    
    # 2. æ‰§è¡Œåˆ†æ
    # ... æ•°æ®è·å–ã€åˆ†æã€LLMæ¨ç† ...
    
    # 3. æ›´æ–°state
    state["data"]["analyst_signals"][agent_id] = analysis_results
    
    # 4. è¿”å›æ›´æ–°åçš„state
    return {
        "messages": state["messages"] + [message],
        "data": state["data"]
    }
```

#### 3. é£é™©ç®¡ç†èŠ‚ç‚¹

```python
def risk_management_agent(state: AgentState, agent_id: str = "risk_management_agent"):
    # 1. è®¡ç®—é£é™©æŒ‡æ ‡
    # 2. è®¾ç½®ä»“ä½é™åˆ¶
    # 3. æ›´æ–°stateä¸­çš„analyst_signals
    return {
        "messages": state["messages"] + [message],
        "data": state["data"]
    }
```

#### 4. æŠ•èµ„ç»„åˆç®¡ç†èŠ‚ç‚¹

```python
def portfolio_management_agent(state: AgentState, agent_id: str = "portfolio_manager"):
    # 1. æ•´åˆæ‰€æœ‰åˆ†æä¿¡å·
    # 2. è€ƒè™‘é£é™©é™åˆ¶
    # 3. ç”Ÿæˆæœ€ç»ˆäº¤æ˜“å†³ç­–
    return {
        "messages": state["messages"] + [message],
        "data": state["data"]
    }
```

---

## å¹¶è¡Œæ‰§è¡Œæœºåˆ¶

### LangGraphçš„å¹¶è¡Œæ‰§è¡Œ

LangGraphæ”¯æŒ**çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œ**ï¼š

1. **å¤šä¸ªèŠ‚ç‚¹è¿æ¥åˆ°åŒä¸€æºèŠ‚ç‚¹**: æ‰€æœ‰ä»`start_node`å‡ºå‘çš„è¾¹ä¼šå¹¶è¡Œæ‰§è¡Œ
2. **è‡ªåŠ¨ç­‰å¾…**: æ‰€æœ‰å¹¶è¡ŒèŠ‚ç‚¹å®Œæˆåï¼Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹
3. **çŠ¶æ€åˆå¹¶**: æ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€æ›´æ–°ä¼šè‡ªåŠ¨åˆå¹¶

### å¹¶è¡Œæ‰§è¡Œç¤ºä¾‹

```python
# æ‰€æœ‰åˆ†ææ™ºèƒ½ä½“å¹¶è¡Œæ‰§è¡Œ
workflow.add_edge("start_node", "warren_buffett_agent")
workflow.add_edge("start_node", "cathie_wood_agent")
workflow.add_edge("start_node", "michael_burry_agent")
# ... æ›´å¤šæ™ºèƒ½ä½“

# æ‰€æœ‰æ™ºèƒ½ä½“å®Œæˆåï¼Œæ‰§è¡Œé£é™©ç®¡ç†
workflow.add_edge("warren_buffett_agent", "risk_management_agent")
workflow.add_edge("cathie_wood_agent", "risk_management_agent")
workflow.add_edge("michael_burry_agent", "risk_management_agent")
```

**æ‰§è¡Œé¡ºåº**:
```
æ—¶é—´çº¿ï¼š
T0: start_node
T1: [warren_buffett, cathie_wood, michael_burry] (å¹¶è¡Œ)
T2: ç­‰å¾…æ‰€æœ‰åˆ†ææ™ºèƒ½ä½“å®Œæˆ
T3: risk_management_agent
T4: portfolio_manager
T5: END
```

---

## çŠ¶æ€åˆå¹¶æœºåˆ¶

### è‡ªåŠ¨åˆå¹¶

LangGraphä½¿ç”¨`Annotated`ç±»å‹å’Œåˆå¹¶å‡½æ•°è‡ªåŠ¨å¤„ç†çŠ¶æ€æ›´æ–°ï¼š

```python
# å®šä¹‰åˆå¹¶å‡½æ•°
def merge_dicts(a: dict, b: dict) -> dict:
    return {**a, **b}

# åœ¨çŠ¶æ€å®šä¹‰ä¸­ä½¿ç”¨
data: Annotated[dict[str, any], merge_dicts]
```

### åˆå¹¶ç¤ºä¾‹

**èŠ‚ç‚¹1è¾“å‡º**:
```python
{
    "data": {
        "analyst_signals": {
            "warren_buffett_agent": {"AAPL": {...}}
        }
    }
}
```

**èŠ‚ç‚¹2è¾“å‡º**:
```python
{
    "data": {
        "analyst_signals": {
            "cathie_wood_agent": {"AAPL": {...}}
        }
    }
}
```

**åˆå¹¶ç»“æœ**:
```python
{
    "data": {
        "analyst_signals": {
            "warren_buffett_agent": {"AAPL": {...}},
            "cathie_wood_agent": {"AAPL": {...}}
        }
    }
}
```

---

## å·¥ä½œæµæ‰§è¡Œ

### ç¼–è¯‘å·¥ä½œæµ

```python
workflow = create_workflow(selected_analysts=["warren_buffett", "cathie_wood"])
agent = workflow.compile()  # ç¼–è¯‘ä¸ºå¯æ‰§è¡Œå¯¹è±¡
```

### æ‰§è¡Œå·¥ä½œæµ

```python
initial_state = {
    "messages": [
        HumanMessage(content="Make trading decisions based on the provided data.")
    ],
    "data": {
        "tickers": ["AAPL", "MSFT"],
        "portfolio": {...},
        "start_date": "2024-01-01",
        "end_date": "2024-01-31",
        "analyst_signals": {}
    },
    "metadata": {
        "show_reasoning": False,
        "model_name": "gpt-4.1",
        "model_provider": "OpenAI"
    }
}

final_state = agent.invoke(initial_state)
```

### è·å–ç»“æœ

```python
# ä»æœ€ç»ˆçŠ¶æ€ä¸­æå–å†³ç­–
decisions = parse_hedge_fund_response(
    final_state["messages"][-1].content
)

# è·å–æ‰€æœ‰æ™ºèƒ½ä½“ä¿¡å·
analyst_signals = final_state["data"]["analyst_signals"]

# è¿”å›ç»“æœ
return {
    "decisions": decisions,
    "analyst_signals": analyst_signals
}
```

---

## å·¥ä½œæµå¯è§†åŒ–

### ç”Ÿæˆå¯è§†åŒ–å›¾

**ä½ç½®**: `src/utils/visualize.py`

```python
from src.utils.visualize import save_graph_as_png

# ä¿å­˜å·¥ä½œæµå›¾ä¸ºPNG
save_graph_as_png(workflow, "workflow.png")
```

### å¯è§†åŒ–å†…å®¹

- èŠ‚ç‚¹ï¼šæ˜¾ç¤ºæ‰€æœ‰æ™ºèƒ½ä½“èŠ‚ç‚¹
- è¾¹ï¼šæ˜¾ç¤ºæ‰§è¡Œé¡ºåº
- å¹¶è¡Œæ‰§è¡Œï¼šå¤šä¸ªèŠ‚ç‚¹ä»åŒä¸€èŠ‚ç‚¹å‡ºå‘

---

## é”™è¯¯å¤„ç†

### èŠ‚ç‚¹é”™è¯¯å¤„ç†

å¦‚æœæŸä¸ªèŠ‚ç‚¹æ‰§è¡Œå¤±è´¥ï¼š

1. **å¼‚å¸¸ä¼ æ’­**: å¼‚å¸¸ä¼šä¼ æ’­åˆ°å·¥ä½œæµå±‚é¢
2. **çŠ¶æ€ä¿ç•™**: å·²å®ŒæˆèŠ‚ç‚¹çš„çŠ¶æ€æ›´æ–°ä¼šä¿ç•™
3. **é”™è¯¯æ¢å¤**: å¯ä»¥æ·»åŠ é”™è¯¯å¤„ç†èŠ‚ç‚¹ï¼ˆæœªæ¥æ”¹è¿›ï¼‰

### å½“å‰å®ç°

```python
try:
    final_state = agent.invoke(initial_state)
except Exception as e:
    print(f"Workflow execution failed: {e}")
    # è¿”å›éƒ¨åˆ†ç»“æœæˆ–é»˜è®¤å€¼
    return default_result
```

---

## æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œæ‰§è¡Œä¼˜åŠ¿

- **æ—¶é—´èŠ‚çœ**: 18ä¸ªæ™ºèƒ½ä½“å¹¶è¡Œæ‰§è¡Œï¼Œæ€»æ—¶é—´ â‰ˆ æœ€æ…¢æ™ºèƒ½ä½“çš„æ—¶é—´
- **èµ„æºåˆ©ç”¨**: å……åˆ†åˆ©ç”¨å¤šæ ¸CPUå’Œç½‘ç»œI/O

### ä¼˜åŒ–å»ºè®®

1. **æ™ºèƒ½ä½“é€‰æ‹©**: åªé€‰æ‹©éœ€è¦çš„æ™ºèƒ½ä½“ï¼Œå‡å°‘æ‰§è¡Œæ—¶é—´
2. **ç¼“å­˜åˆ©ç”¨**: å……åˆ†åˆ©ç”¨æ•°æ®ç¼“å­˜ï¼Œå‡å°‘APIè°ƒç”¨
3. **æ‰¹é‡å¤„ç†**: å¯¹å¤šä¸ªtickeræ‰¹é‡å¤„ç†ï¼ˆå¦‚æœAPIæ”¯æŒï¼‰

---

## æ‰©å±•å·¥ä½œæµ

### æ·»åŠ æ¡ä»¶è·¯ç”±

```python
def should_continue(state: AgentState) -> str:
    """åŸºäºçŠ¶æ€å†³å®šä¸‹ä¸€æ­¥"""
    if some_condition(state):
        return "path_a"
    else:
        return "path_b"

workflow.add_conditional_edges(
    "decision_node",
    should_continue,
    {
        "path_a": "node_a",
        "path_b": "node_b"
    }
)
```

### æ·»åŠ å¾ªç¯

```python
def check_completion(state: AgentState) -> str:
    if state["data"]["iteration"] >= max_iterations:
        return "end"
    return "continue"

workflow.add_conditional_edges(
    "loop_node",
    check_completion,
    {
        "continue": "loop_node",  # å¾ªç¯
        "end": END
    }
)
```

---

## æ€»ç»“

å·¥ä½œæµå¼•æ“é€šè¿‡LangGraphå®ç°äº†çµæ´»ã€é«˜æ•ˆçš„å¤šæ™ºèƒ½ä½“åä½œæœºåˆ¶ã€‚é€šè¿‡çŠ¶æ€ç®¡ç†å’Œå¹¶è¡Œæ‰§è¡Œï¼Œç³»ç»Ÿèƒ½å¤Ÿåè°ƒ18ä¸ªæ™ºèƒ½ä½“åŒæ—¶å·¥ä½œï¼Œæœ€ç»ˆç”Ÿæˆç»¼åˆçš„æŠ•èµ„å†³ç­–ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
- âœ… åŸºäºLangGraphçš„çŠ¶æ€æœºæ¨¡å‹
- âœ… æ”¯æŒçœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œ
- âœ… è‡ªåŠ¨çŠ¶æ€åˆå¹¶
- âœ… çµæ´»çš„å·¥ä½œæµé…ç½®
- âœ… æ˜“äºæ‰©å±•å’Œå®šåˆ¶

**å·¥ä½œæµä¼˜åŠ¿**:
- ğŸš€ å¹¶è¡Œæ‰§è¡Œï¼ŒèŠ‚çœæ—¶é—´
- ğŸ”„ çŠ¶æ€è‡ªåŠ¨ç®¡ç†
- ğŸ¯ æ¸…æ™°çš„æ‰§è¡Œé¡ºåº
- ğŸ› ï¸ æ˜“äºè°ƒè¯•å’Œå¯è§†åŒ–

