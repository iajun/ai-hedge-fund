# 性能指标计算详细文档

## 概述

性能指标计算模块负责计算投资组合的各种风险调整后收益指标，用于评估策略表现。

**位置**: `src/backtesting/metrics.py`

---

## 计算的指标

### 1. Sharpe比率

**定义**: 衡量风险调整后的超额收益

**公式**:
```
Sharpe Ratio = (平均超额收益 / 超额收益标准差) × √252
```

**其中**:
- 平均超额收益 = 平均日收益率 - 无风险日利率
- 超额收益标准差 = 日收益率的标准差
- 252 = 年化因子（交易日数）

**实现**:
```python
# 计算日收益率
daily_returns = df["Portfolio Value"].pct_change().dropna()

# 计算无风险日利率（默认年化4.34%）
daily_rf = self.annual_rf_rate / self.annual_trading_days  # 4.34% / 252

# 计算超额收益
excess = daily_returns - daily_rf

# 计算Sharpe比率
mean_excess = excess.mean()
std_excess = excess.std()

if std_excess > 1e-12:
    sharpe = np.sqrt(self.annual_trading_days) * (mean_excess / std_excess)
else:
    sharpe = 0.0
```

**解释**:
- **> 1**: 优秀
- **0.5 - 1**: 良好
- **0 - 0.5**: 一般
- **< 0**: 表现不佳

---

### 2. Sortino比率

**定义**: 类似Sharpe比率，但只考虑下行波动

**公式**:
```
Sortino Ratio = (平均超额收益 / 下行标准差) × √252
```

**其中**:
- 下行标准差 = 负收益的标准差

**实现**:
```python
# 计算超额收益
excess = daily_returns - daily_rf

# 只考虑负收益
negative_excess = excess[excess < 0]

if len(negative_excess) > 0:
    downside_std = negative_excess.std()
    if downside_std > 1e-12:
        sortino = np.sqrt(self.annual_trading_days) * (mean_excess / downside_std)
    else:
        sortino = float("inf") if mean_excess > 0 else 0.0
else:
    # 没有负收益，Sortino为无穷大（如果平均收益为正）
    sortino = float("inf") if mean_excess > 0 else 0.0
```

**优势**: 
- 更关注下行风险
- 对波动性较大的策略更公平

---

### 3. 最大回撤（Maximum Drawdown）

**定义**: 从峰值到谷值的最大跌幅

**公式**:
```
回撤 = (当前价值 - 历史最高价值) / 历史最高价值
最大回撤 = min(所有回撤)
```

**实现**:
```python
# 计算累计最大值
rolling_max = df["Portfolio Value"].cummax()

# 计算回撤
drawdown = (df["Portfolio Value"] - rolling_max) / rolling_max

# 最大回撤（转换为百分比）
if len(drawdown) > 0:
    min_dd = float(drawdown.min())
    max_drawdown = float(min_dd * 100.0)
    
    # 最大回撤日期
    if min_dd < 0:
        max_drawdown_date = drawdown.idxmin().strftime("%Y-%m-%d")
    else:
        max_drawdown_date = None
else:
    max_drawdown = 0.0
    max_drawdown_date = None
```

**解释**:
- **-10%**: 最大损失10%
- **-20%**: 最大损失20%
- 越小越好（绝对值越大越差）

---

### 4. 多空比率（Long/Short Ratio）

**位置**: `src/backtesting/valuation.py` - `compute_exposures()`

**定义**: 多头敞口与空头敞口的比率

**公式**:
```
Long/Short Ratio = 多头敞口 / 空头敞口
```

**实现**:
```python
long_exposure = sum(long_shares * price for each ticker)
short_exposure = sum(short_shares * price for each ticker)

if short_exposure > 0:
    long_short_ratio = long_exposure / short_exposure
elif long_exposure > 0:
    long_short_ratio = float("inf")  # 只有多头
else:
    long_short_ratio = 0.0  # 无持仓
```

**解释**:
- **> 1**: 偏多策略
- **= 1**: 市场中性
- **< 1**: 偏空策略
- **∞**: 纯多头
- **0**: 纯空头或无持仓

---

### 5. 总敞口（Gross Exposure）

**定义**: 多头和空头敞口的绝对值之和

**公式**:
```
Gross Exposure = |多头敞口| + |空头敞口|
```

**实现**:
```python
gross_exposure = long_exposure + short_exposure
```

**解释**:
- 衡量策略的活跃程度
- 高总敞口 = 高杠杆/高活跃度

---

### 6. 净敞口（Net Exposure）

**定义**: 多头和空头敞口的差值

**公式**:
```
Net Exposure = 多头敞口 - 空头敞口
```

**实现**:
```python
net_exposure = long_exposure - short_exposure
```

**解释**:
- **> 0**: 净多头
- **= 0**: 市场中性
- **< 0**: 净空头

---

## PerformanceMetricsCalculator类

### 初始化

```python
class PerformanceMetricsCalculator:
    def __init__(
        self, 
        *, 
        annual_trading_days: int = 252,
        annual_rf_rate: float = 0.0434
    ):
        self.annual_trading_days = annual_trading_days  # 年化交易日数
        self.annual_rf_rate = annual_rf_rate            # 年化无风险利率（4.34%）
```

### 计算指标

```python
def compute_metrics(
    self, 
    values: Sequence[PortfolioValuePoint]
) -> PerformanceMetrics:
    """
    计算性能指标
    
    参数:
        values: 投资组合价值点序列
        
    返回:
        PerformanceMetrics: 包含所有指标的字典
    """
    # 1. 转换为DataFrame
    df = pd.DataFrame(values)
    df = df.set_index("Date")
    
    # 2. 计算日收益率
    df["Daily Return"] = df["Portfolio Value"].pct_change()
    clean_returns = df["Daily Return"].dropna()
    
    # 3. 检查数据充足性
    if len(clean_returns) < 2:
        return {
            "sharpe_ratio": None,
            "sortino_ratio": None,
            "max_drawdown": None,
            "max_drawdown_date": None,
        }
    
    # 4. 计算Sharpe比率
    sharpe = self._calculate_sharpe(clean_returns)
    
    # 5. 计算Sortino比率
    sortino = self._calculate_sortino(clean_returns)
    
    # 6. 计算最大回撤
    max_drawdown, max_drawdown_date = self._calculate_max_drawdown(df)
    
    return {
        "sharpe_ratio": sharpe,
        "sortino_ratio": sortino,
        "max_drawdown": max_drawdown,
        "max_drawdown_date": max_drawdown_date,
    }
```

---

## PortfolioValuePoint结构

### 数据点定义

```python
class PortfolioValuePoint(TypedDict):
    Date: datetime
    Portfolio Value: float
    Long Exposure: float
    Short Exposure: float
    Gross Exposure: float
    Net Exposure: float
    Long/Short Ratio: float
```

### 示例数据

```python
[
    {
        "Date": datetime(2024, 1, 1),
        "Portfolio Value": 100000.0,
        "Long Exposure": 50000.0,
        "Short Exposure": 0.0,
        "Gross Exposure": 50000.0,
        "Net Exposure": 50000.0,
        "Long/Short Ratio": float("inf")
    },
    {
        "Date": datetime(2024, 1, 2),
        "Portfolio Value": 101000.0,
        "Long Exposure": 50500.0,
        "Short Exposure": 0.0,
        "Gross Exposure": 50500.0,
        "Net Exposure": 50500.0,
        "Long/Short Ratio": float("inf")
    },
    # ...
]
```

---

## 指标更新时机

### 实时更新

在回测循环中，每处理完一个交易日：

```python
# 更新性能指标（至少需要3个数据点）
if len(self._portfolio_values) > 3:
    computed = self._perf.compute_metrics(self._portfolio_values)
    if computed:
        self._performance_metrics.update(computed)
```

### 最终计算

回测结束后，计算最终指标：

```python
performance_metrics = backtester.run_backtest()
# 返回完整的性能指标
```

---

## 指标解释指南

### 综合评估

**优秀策略特征**:
- Sharpe比率 > 1.0
- Sortino比率 > 1.5
- 最大回撤 < -20%
- 稳定的收益曲线

**一般策略特征**:
- Sharpe比率 0.5 - 1.0
- Sortino比率 0.5 - 1.5
- 最大回撤 -20% 到 -30%

**较差策略特征**:
- Sharpe比率 < 0.5
- Sortino比率 < 0.5
- 最大回撤 > -30%

### 风险提示

1. **历史表现不代表未来**: 回测结果基于历史数据
2. **过拟合风险**: 过度优化可能导致未来表现不佳
3. **市场环境变化**: 不同市场环境下表现可能不同
4. **交易成本**: 实际交易需要考虑手续费、滑点等

---

## 扩展指标

### 可添加的指标

1. **Calmar比率**: 年化收益 / 最大回撤
2. **信息比率**: 超额收益 / 跟踪误差
3. **Beta**: 相对于基准的敏感性
4. **Alpha**: 超额收益（风险调整后）
5. **胜率**: 盈利交易占比
6. **盈亏比**: 平均盈利 / 平均亏损

### 实现示例

```python
def calculate_calmar_ratio(
    portfolio_values: Sequence[PortfolioValuePoint],
    max_drawdown: float
) -> float:
    """计算Calmar比率"""
    if max_drawdown == 0:
        return 0.0
    
    # 计算年化收益率
    first_value = portfolio_values[0]["Portfolio Value"]
    last_value = portfolio_values[-1]["Portfolio Value"]
    total_return = (last_value - first_value) / first_value
    
    # 假设回测期为1年
    annual_return = total_return
    
    # Calmar = 年化收益 / 最大回撤（绝对值）
    calmar = annual_return / abs(max_drawdown / 100.0)
    
    return calmar
```

---

## 总结

性能指标计算模块提供了全面的策略评估指标，帮助量化分析师理解策略的风险收益特征。通过Sharpe、Sortino、最大回撤等指标，可以从多个角度评估策略表现。

**核心特点**:
- ✅ 多种风险调整后收益指标
- ✅ 实时计算和更新
- ✅ 详细的回撤分析
- ✅ 敞口分析支持
- ✅ 易于扩展新指标

