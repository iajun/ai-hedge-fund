# AI Hedge Fund 项目架构与核心理念文档

## 目录
1. [产品架构](#产品架构)
2. [项目架构](#项目架构)
3. [核心理念与思想](#核心理念与思想)
4. [A股智能回测与预测可行性分析](#a股智能回测与预测可行性分析)

## 📚 详细技术文档

本文档提供了项目的高层架构概览。如需深入了解各个模块的具体实现，请参考以下详细技术文档：

- **[数据源层](./docs/01-数据源层.md)** - 数据获取API、数据源信息、API请求处理
- **[数据缓存层](./docs/02-数据缓存层.md)** - 缓存架构、缓存操作、性能优化
- **[智能体系统](./docs/03-智能体系统.md)** - 18个投资策略智能体详解、工作流程、LLM集成
- **[工作流引擎](./docs/04-工作流引擎.md)** - LangGraph工作流架构、状态管理、并行执行
- **[回测引擎](./docs/05-回测引擎.md)** - 回测架构、时间序列模拟、交易执行、性能计算
- **[性能指标计算](./docs/06-性能指标计算.md)** - Sharpe、Sortino、最大回撤等指标详解

**完整文档索引**: [docs/README.md](./docs/README.md)

---

## 产品架构

### 1.1 整体架构概览

AI Hedge Fund 是一个基于多智能体协作的AI驱动投资决策系统，采用**分层式架构**设计：

```
┌─────────────────────────────────────────────────────────────┐
│                     用户交互层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Web前端界面 │  │  命令行接口   │  │  API接口     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                     业务逻辑层                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           多智能体决策引擎 (LangGraph)                │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │ 分析智能体 │  │ 风险管理   │  │ 组合管理   │    │   │
│  │  │ (18个策略) │→ │ 智能体     │→ │ 智能体     │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                 回测引擎                              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ 控制器   │  │ 交易执行 │  │ 性能计算 │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                     数据服务层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 数据API接口  │  │  数据缓存     │  │  数据库      │      │
│  │ (Financial   │  │  (本地缓存)   │  │  (SQLite)    │      │
│  │  Datasets)   │  │               │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件详解

#### 1.2.1 多智能体决策系统

系统采用**18个专业投资策略智能体**，每个智能体代表不同的投资理念：

**价值投资流派：**
- **Warren Buffett Agent** - 奥马哈先知，寻找优质公司
- **Ben Graham Agent** - 价值投资之父，寻找安全边际
- **Charlie Munger Agent** - 理性思考者，优质企业
- **Michael Burry Agent** - 反向投资者，深度价值
- **Mohnish Pabrai Agent** - Dhandho投资者，低风险高回报

**成长投资流派：**
- **Cathie Wood Agent** - 成长投资女王，颠覆性创新
- **Peter Lynch Agent** - 10倍股投资者，买你了解的公司
- **Phil Fisher Agent** - 深度研究投资者，长期增长

**宏观与策略流派：**
- **Stanley Druckenmiller Agent** - 宏观投资者，不对称机会
- **Bill Ackman Agent** - 激进投资者，推动变革
- **Rakesh Jhunjhunwala Agent** - 印度大牛，新兴市场

**量化分析流派：**
- **Aswath Damodaran Agent** - 估值大师，内在价值
- **Valuation Agent** - 估值分析师
- **Fundamentals Agent** - 基本面分析师
- **Technicals Agent** - 技术分析师
- **Sentiment Agent** - 市场情绪分析师
- **News Sentiment Agent** - 新闻情绪分析师
- **Growth Agent** - 增长分析师

**风险管理：**
- **Risk Manager** - 计算风险指标，设置仓位限制
- **Portfolio Manager** - 最终交易决策，生成订单

#### 1.2.2 工作流引擎

使用 **LangGraph** 构建状态机工作流：

```
开始节点
  ↓
┌─────────────────────────────────┐
│  并行执行所有选定的分析智能体     │
│  (每个智能体独立分析股票)        │
└─────────────────────────────────┘
  ↓ (所有智能体完成)
┌─────────────────────────────────┐
│  风险管理智能体                  │
│  - 计算风险指标                  │
│  - 设置仓位限制                  │
│  - 评估市场风险                  │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│  投资组合管理智能体              │
│  - 整合所有分析信号              │
│  - 考虑风险限制                  │
│  - 生成最终交易决策              │
└─────────────────────────────────┘
  ↓
结束节点
```

#### 1.2.3 回测引擎

回测系统采用**时间序列模拟**方式：

1. **数据预取**：提前加载历史数据到缓存
2. **逐日模拟**：
   - 对每个交易日，调用多智能体系统生成交易决策
   - 执行交易（买入/卖出/做空/平仓）
   - 计算投资组合价值
   - 更新风险指标
3. **性能计算**：
   - Sharpe比率
   - Sortino比率
   - 最大回撤
   - 多空比率
   - 总敞口/净敞口
4. **基准对比**：与SPY等基准指数对比

### 1.3 数据流架构

```
外部数据源 (Financial Datasets API)
    ↓
数据获取层 (src/tools/api.py)
    ↓
数据缓存层 (src/data/cache.py) - 本地JSON缓存
    ↓
智能体分析层 (src/agents/*.py)
    ↓
状态管理 (src/graph/state.py)
    ↓
决策输出 (交易信号)
    ↓
回测执行 (src/backtesting/engine.py)
    ↓
结果展示 (性能指标、图表)
```

---

## 项目架构

### 2.1 技术栈

#### 后端技术栈
- **语言**: Python 3.11+
- **Web框架**: FastAPI
- **AI框架**: 
  - LangChain (LLM抽象层)
  - LangGraph (工作流编排)
- **数据库**: 
  - SQLite (开发环境)
  - SQLAlchemy (ORM)
  - Alembic (数据库迁移)
- **数据处理**: Pandas, NumPy
- **依赖管理**: Poetry

#### 前端技术栈
- **框架**: React 18+ with TypeScript
- **构建工具**: Vite
- **UI组件**: 
  - shadcn/ui (基于Radix UI)
  - Tailwind CSS
- **状态管理**: React Context API
- **可视化**: React Flow (工作流可视化)

#### 数据源
- **金融数据API**: Financial Datasets API
  - 股票价格数据
  - 财务指标
  - 财务报表项目
  - 内幕交易
  - 公司新闻

### 2.2 目录结构

```
ai-hedge-fund/
├── src/                          # 核心业务逻辑
│   ├── agents/                  # 18个投资策略智能体
│   │   ├── warren_buffett.py
│   │   ├── cathie_wood.py
│   │   └── ...
│   ├── backtesting/             # 回测引擎
│   │   ├── engine.py           # 回测主引擎
│   │   ├── controller.py       # 智能体控制器
│   │   ├── trader.py           # 交易执行器
│   │   ├── portfolio.py        # 投资组合管理
│   │   ├── metrics.py          # 性能指标计算
│   │   └── benchmarks.py       # 基准对比
│   ├── graph/                   # 工作流状态管理
│   │   └── state.py            # AgentState定义
│   ├── data/                    # 数据模型和缓存
│   │   ├── models.py           # Pydantic数据模型
│   │   └── cache.py            # 本地缓存实现
│   ├── tools/                   # 工具函数
│   │   └── api.py              # 数据API封装
│   ├── utils/                   # 工具函数
│   │   ├── analysts.py         # 智能体配置
│   │   ├── llm.py              # LLM调用封装
│   │   └── ...
│   ├── main.py                  # CLI入口
│   └── backtester.py           # 回测CLI入口
│
├── app/                         # Web应用
│   ├── backend/                 # FastAPI后端
│   │   ├── main.py             # FastAPI应用入口
│   │   ├── routes/             # API路由
│   │   │   ├── flows.py       # 工作流管理
│   │   │   ├── flow_runs.py   # 运行管理
│   │   │   └── ...
│   │   ├── services/           # 业务服务层
│   │   │   ├── agent_service.py
│   │   │   ├── backtest_service.py
│   │   │   └── ...
│   │   ├── database/           # 数据库层
│   │   │   ├── models.py      # SQLAlchemy模型
│   │   │   └── connection.py  # 数据库连接
│   │   └── repositories/       # 数据访问层
│   │
│   └── frontend/               # React前端
│       ├── src/
│       │   ├── components/    # React组件
│       │   │   ├── Flow.tsx   # 工作流可视化
│       │   │   ├── panels/    # 各种面板组件
│       │   │   └── ...
│       │   ├── contexts/      # Context状态管理
│       │   ├── services/      # API服务
│       │   └── ...
│       └── ...
│
└── tests/                       # 测试代码
    └── backtesting/            # 回测测试
```

### 2.3 核心模块设计

#### 2.3.1 智能体模块设计模式

每个智能体遵循统一的接口模式：

```python
def agent_name_agent(state: AgentState, agent_id: str = "agent_name_agent"):
    """
    1. 从state中提取数据（tickers, dates, portfolio等）
    2. 获取API密钥
    3. 对每个ticker：
       a. 获取财务数据（价格、指标、新闻等）
       b. 进行专业分析
       c. 调用LLM生成投资信号
    4. 返回更新后的state
    """
    # 数据获取
    # 分析处理
    # LLM推理
    # 返回信号
```

#### 2.3.2 状态管理

使用 `AgentState` TypedDict 管理全局状态：

```python
class AgentState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], operator.add]  # LLM消息历史
    data: Annotated[dict[str, any], merge_dicts]              # 业务数据
    metadata: Annotated[dict[str, any], merge_dicts]          # 元数据
```

#### 2.3.3 数据缓存机制

- **缓存策略**: 本地JSON文件缓存
- **缓存键**: 基于参数组合（ticker + date + limit等）
- **缓存位置**: `src/data/cache.py`
- **优势**: 减少API调用，加速回测

### 2.4 数据库设计

#### 核心表结构

1. **hedge_fund_flows** - 工作流配置
   - 存储React Flow的节点、边、视口状态
   - 支持工作流模板

2. **hedge_fund_flow_runs** - 运行记录
   - 跟踪每次执行的配置和结果
   - 存储初始和最终投资组合状态

3. **hedge_fund_flow_run_cycles** - 分析周期
   - 记录每个分析周期的详细结果
   - 包含智能体信号、交易决策、性能指标

4. **api_keys** - API密钥管理
   - 安全存储各种服务的API密钥

---

## 核心理念与思想

### 3.1 多智能体协作决策

#### 核心理念

**"集思广益，专业分工"** - 通过多个专业投资策略智能体的协作，模拟真实投资团队的多角度分析。

#### 设计思想

1. **策略多样性**
   - 每个智能体代表一种独特的投资哲学
   - 从价值投资到成长投资，从基本面到技术面
   - 覆盖不同的投资风格和风险偏好

2. **并行分析**
   - 所有智能体并行工作，互不干扰
   - 提高分析效率
   - 每个智能体专注于自己的专业领域

3. **信号融合**
   - 风险管理智能体整合所有信号
   - 考虑风险限制和仓位约束
   - 投资组合管理智能体做出最终决策

### 3.2 AI驱动的投资决策

#### 核心理念

**"AI增强人类智慧"** - 使用大语言模型(LLM)来理解和应用投资大师的思维模式。

#### 实现方式

1. **知识嵌入**
   - 每个智能体的提示词(Prompt)包含对应投资大师的核心原则
   - LLM理解并应用这些投资理念
   - 结合实时财务数据进行分析

2. **推理能力**
   - LLM能够进行复杂的多因素分析
   - 理解财务指标之间的关系
   - 生成结构化的投资建议

3. **可解释性**
   - 每个决策都包含详细的推理过程
   - 用户可以查看每个智能体的分析逻辑
   - 提高决策的透明度和可信度

### 3.3 风险优先原则

#### 核心理念

**"先控制风险，再追求收益"** - 风险管理是投资决策的核心环节。

#### 实现机制

1. **独立风险管理**
   - 风险管理智能体在所有分析智能体之后运行
   - 评估市场风险、个股风险、组合风险
   - 设置仓位限制和风险阈值

2. **约束驱动决策**
   - 投资组合管理智能体必须遵守风险限制
   - 在风险约束内优化收益
   - 防止过度集中和过度杠杆

### 3.4 回测验证思想

#### 核心理念

**"历史验证，数据说话"** - 通过历史数据验证投资策略的有效性。

#### 设计特点

1. **真实模拟**
   - 使用真实历史价格数据
   - 考虑交易成本和市场冲击
   - 模拟真实的交易执行

2. **全面评估**
   - 计算多种性能指标
   - 与基准指数对比
   - 分析风险调整后收益

3. **迭代优化**
   - 通过回测发现策略问题
   - 调整智能体参数和逻辑
   - 持续改进投资决策质量

### 3.5 教育导向

#### 核心理念

**"学习工具，非交易工具"** - 系统设计用于教育和研究，而非实际交易。

#### 设计考量

1. **透明度**
   - 所有决策过程可追溯
   - 展示每个智能体的分析过程
   - 帮助用户理解投资决策逻辑

2. **可扩展性**
   - 易于添加新的投资策略智能体
   - 支持自定义工作流
   - 灵活的配置选项

3. **安全性**
   - 不连接真实交易账户
   - 仅进行模拟交易
   - 明确免责声明

---

## A股智能回测与预测可行性分析

### 4.1 当前系统对A股的支持情况

#### 4.1.1 架构层面的兼容性

**✅ 高度兼容**

1. **智能体系统**
   - 所有18个投资策略智能体的逻辑与市场无关
   - 投资理念（价值投资、成长投资等）适用于任何市场
   - 只需适配数据源，无需修改智能体核心逻辑

2. **工作流引擎**
   - LangGraph工作流框架与市场无关
   - 状态管理和消息传递机制通用
   - 可直接应用于A股市场

3. **回测引擎**
   - 回测引擎设计为市场无关
   - 支持任意时间序列数据
   - 交易执行逻辑适用于A股（买入/卖出）

#### 4.1.2 数据层面的限制

**❌ 需要适配**

1. **数据源限制**
   - 当前使用 `Financial Datasets API`，主要支持美股
   - 需要替换为A股数据源，例如：
     - 聚宽/米筐/优矿等量化平台API
     - 同花顺/东方财富等金融数据API
     - 自建数据爬取系统

2. **数据格式差异**
   - A股代码格式（如：000001.SZ, 600000.SH）
   - 交易时间差异（A股T+1，美股T+0）
   - 涨跌停板限制（A股±10%，美股无限制）
   - 交易单位差异（A股100股/手，美股1股）

3. **财务数据差异**
   - 财务报表格式（A股使用中国会计准则）
   - 财务指标计算方式可能不同
   - 需要适配中文财务术语

### 4.2 A股适配方案

#### 4.2.1 数据层适配

**方案一：使用量化平台API（推荐）**

```python
# 示例：适配聚宽API
def get_a_share_prices(ticker: str, start_date: str, end_date: str):
    """
    获取A股价格数据
    ticker格式: 000001.SZ (深交所) 或 600000.SH (上交所)
    """
    # 调用聚宽/米筐等API
    # 返回统一格式的Price对象
    pass
```

**方案二：自建数据服务**

- 使用 `akshare`、`tushare` 等Python库
- 或直接连接Wind、Choice等专业数据终端
- 建立数据缓存和更新机制

#### 4.2.2 交易规则适配

需要在回测引擎中添加A股特有规则：

```python
# src/backtesting/trader.py 需要修改
class AShareTradeExecutor(TradeExecutor):
    def execute_trade(self, ticker, action, qty, price, portfolio):
        # A股特有规则：
        # 1. 检查涨跌停板限制
        # 2. T+1交易限制（当日买入不能当日卖出）
        # 3. 最小交易单位（100股/手）
        # 4. 交易时间（9:30-11:30, 13:00-15:00）
        pass
```

#### 4.2.3 智能体提示词适配

部分智能体的提示词可能需要针对A股市场特点进行调整：

```python
# 示例：添加A股市场说明
A_SHARE_CONTEXT = """
注意：这是A股市场分析
- 交易时间：9:30-11:30, 13:00-15:00
- 涨跌停限制：±10%（ST股±5%）
- T+1交易制度
- 最小交易单位：100股
"""
```

### 4.3 A股回测功能实现路径

#### 阶段一：数据源适配（1-2周）

1. **选择数据源**
   - 评估akshare、tushare、聚宽等选项
   - 考虑数据质量、更新频率、成本

2. **实现数据接口**
   - 在 `src/tools/api.py` 中添加A股数据获取函数
   - 保持与现有接口的兼容性
   - 实现数据格式转换

3. **更新数据模型**
   - 在 `src/data/models.py` 中添加A股特有字段
   - 处理A股代码格式

#### 阶段二：交易规则适配（1周）

1. **修改交易执行器**
   - 实现A股交易规则检查
   - 处理涨跌停、T+1等限制

2. **更新回测引擎**
   - 适配A股交易时间
   - 处理停牌、复牌等特殊情况

#### 阶段三：测试与优化（1-2周）

1. **回测验证**
   - 使用历史A股数据回测
   - 验证交易逻辑正确性
   - 对比实际市场表现

2. **性能优化**
   - 优化数据获取速度
   - 改进缓存策略

### 4.4 A股预测功能评估

#### 4.4.1 技术可行性

**✅ 完全可行**

1. **智能体系统**
   - 所有18个智能体都可以用于A股预测
   - LLM的推理能力不依赖市场类型
   - 投资理念适用于A股市场

2. **数据支持**
   - A股市场数据丰富（价格、财务、新闻等）
   - 可以获取足够的历史数据用于训练和验证

#### 4.4.2 实际挑战

1. **市场特性**
   - A股市场波动性较大
   - 政策影响显著
   - 散户情绪影响明显

2. **数据质量**
   - 需要确保数据准确性和及时性
   - 财务数据披露时间可能不同

3. **监管环境**
   - 需要注意合规要求
   - 避免涉及内幕信息

### 4.5 结论与建议

#### 4.5.1 可行性结论

**✅ 系统架构完全支持A股回测和预测**

- 核心架构与市场无关，可直接应用
- 智能体系统设计灵活，易于适配
- 回测引擎支持任意市场数据

**⚠️ 需要完成适配工作**

- 数据源替换（1-2周工作量）
- 交易规则适配（1周工作量）
- 测试验证（1-2周工作量）

#### 4.5.2 实施建议

1. **短期方案（快速验证）**
   - 使用 `akshare` 或 `tushare` 获取A股数据
   - 最小化修改现有代码
   - 快速验证可行性

2. **长期方案（生产级）**
   - 建立专业数据服务
   - 实现完整的数据缓存和更新机制
   - 添加A股特有的风险控制规则
   - 优化性能和稳定性

3. **扩展功能**
   - 支持港股、美股等多市场
   - 实现跨市场套利策略
   - 添加更多A股特有的技术指标

#### 4.5.3 预期效果

完成A股适配后，系统将能够：

1. **回测功能**
   - 使用历史A股数据回测各种投资策略
   - 评估策略在A股市场的有效性
   - 优化投资组合配置

2. **预测功能**
   - 基于当前市场数据生成A股投资建议
   - 多角度分析A股标的
   - 提供风险调整后的投资信号

3. **教育价值**
   - 帮助理解不同投资策略在A股市场的表现
   - 学习投资大师的思维模式
   - 提升投资决策能力

---

## 总结

AI Hedge Fund 是一个设计精良的多智能体投资决策系统，其架构设计具有高度的**市场无关性**和**可扩展性**。通过适配A股数据源和交易规则，系统完全可以用于A股市场的智能回测和预测。核心的智能体系统、工作流引擎和回测框架都无需修改，只需要在数据层和交易执行层进行适配即可。

**关键优势：**
- ✅ 架构设计优秀，易于扩展
- ✅ 多智能体协作，决策全面
- ✅ 风险优先，安全可靠
- ✅ 回测完善，验证充分

**适配工作量：**
- 数据源适配：1-2周
- 交易规则适配：1周
- 测试优化：1-2周
- **总计：3-5周可完成A股适配**

---

*本文档版本：1.0*  
*最后更新：2025年*

